<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Noise Texture Generator</title>
  <style>
    body {
      font-family: sans-serif;
      background: #111827;
      color: #e5e7eb;
      margin: 0;
      padding: 16px;
    }
    .section {
      margin-bottom: 24px;
      background: #1f2937;
      padding: 16px;
      border-radius: 8px;
    }
    label {
      display: block;
      margin-top: 12px;
      font-size: 14px;
    }
    input, select {
      width: 100%;
      padding: 6px;
      margin-top: 4px;
      border-radius: 6px;
      border: 1px solid #374151;
      background: #111827;
      color: #f3f4f6;
    }
    button {
      width: 100%;
      margin-top: 16px;
      padding: 10px;
      background: #3b82f6;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: bold;
    }
    canvas {
      display: block;
      margin: 16px auto 0;
      background: #374151;
      border-radius: 8px;
    }
  </style>
</head>
<body>
  <div class="section">
    <h2>Noise Texture Generator</h2>
    
    <label for="noiseType">Noise Type</label>
    <select id="noiseType">
      <option value="white">White Noise</option>
      <option value="perlin">Perlin Noise</option>
      <option value="simplex">Simplex Noise</option>
      <option value="worley">Worley Noise</option>
    </select>

    <label for="scale">Scale</label>
    <input type="range" id="scale" min="10" max="200" value="80" />

    <label for="color1">Color 1</label>
    <input type="color" id="color1" value="#000000" />

    <label for="color2">Color 2</label>
    <input type="color" id="color2" value="#ffffff" />

    <button id="generate">Generate Texture</button>
  </div>

  <div class="section">
    <h2>Preview</h2>
    <canvas id="previewCanvas" width="200" height="200"></canvas>
    <button id="applyPattern">Apply to Selection</button>
  </div>

  <script>
    const canvas = document.getElementById("previewCanvas");
    const ctx = canvas.getContext("2d");

    const noiseType = document.getElementById("noiseType");
    const scaleSlider = document.getElementById("scale");
    const color1Picker = document.getElementById("color1");
    const color2Picker = document.getElementById("color2");

    const WIDTH = canvas.width;
    const HEIGHT = canvas.height;

    const randomPoints = Array.from({ length: 40 }, () => ({
      x: Math.random(),
      y: Math.random()
    }));

    document.getElementById("generate").onclick = () => {
      const scale = parseInt(scaleSlider.value);
      const color1 = hexToRgb(color1Picker.value);
      const color2 = hexToRgb(color2Picker.value);
      const type = noiseType.value;

      const imageData = ctx.createImageData(WIDTH, HEIGHT);

      for (let y = 0; y < HEIGHT; y++) {
        for (let x = 0; x < WIDTH; x++) {
          const i = (y * WIDTH + x) * 4;
          const nx = x / scale;
          const ny = y / scale;

          let t = 0;

          if (type === "white") {
            t = Math.random();
          } else if (type === "perlin") {
            t = perlin2(nx, ny) * 0.5 + 0.5;
          } else if (type === "simplex") {
            t = simplex2(nx, ny) * 0.5 + 0.5;
          } else if (type === "worley") {
            t = worley2(nx, ny);
          }

          imageData.data[i + 0] = color1.r + t * (color2.r - color1.r);
          imageData.data[i + 1] = color1.g + t * (color2.g - color1.g);
          imageData.data[i + 2] = color1.b + t * (color2.b - color1.b);
          imageData.data[i + 3] = 255;
        }
      }

      ctx.putImageData(imageData, 0, 0);
    };

    document.getElementById("applyPattern").onclick = () => {
      const dataURL = canvas.toDataURL("image/png");
      parent.postMessage({
        pluginMessage: {
          type: "apply-pattern",
          base64: dataURL.split(",")[1]
        }
      }, "*");
    };

    function hexToRgb(hex) {
      const num = parseInt(hex.slice(1), 16);
      return {
        r: (num >> 16) & 255,
        g: (num >> 8) & 255,
        b: num & 255,
      };
    }

    // --- Perlin Noise ---
    const perm = new Uint8Array(512);
    const grad2 = [[1,1],[-1,1],[1,-1],[-1,-1],[1,0],[-1,0],[0,1],[0,-1]];
    for (let i = 0; i < 256; i++) perm[i] = i;
    for (let i = 0; i < 256; i++) {
      const j = Math.floor(Math.random() * 256);
      [perm[i], perm[j]] = [perm[j], perm[i]];
    }
    for (let i = 0; i < 256; i++) perm[i + 256] = perm[i];

    function fade(t) {
      return t * t * t * (t * (t * 6 - 15) + 10);
    }

    function lerp(a, b, t) {
      return a + t * (b - a);
    }

    function grad(hash, x, y) {
      const g = grad2[hash & 7];
      return g[0] * x + g[1] * y;
    }

    function perlin2(x, y) {
      const X = Math.floor(x) & 255;
      const Y = Math.floor(y) & 255;

      x -= Math.floor(x);
      y -= Math.floor(y);

      const u = fade(x);
      const v = fade(y);

      const aa = perm[X + perm[Y]];
      const ab = perm[X + perm[Y + 1]];
      const ba = perm[X + 1 + perm[Y]];
      const bb = perm[X + 1 + perm[Y + 1]];

      return lerp(
        lerp(grad(aa, x, y), grad(ba, x - 1, y), u),
        lerp(grad(ab, x, y - 1), grad(bb, x - 1, y - 1), u),
        v
      );
    }

    // --- Simplex Noise ---
    function simplex2(xin, yin) {
      const F2 = 0.5 * (Math.sqrt(3) - 1);
      const G2 = (3 - Math.sqrt(3)) / 6;

      const s = (xin + yin) * F2;
      const i = Math.floor(xin + s);
      const j = Math.floor(yin + s);
      const t = (i + j) * G2;
      const X0 = i - t;
      const Y0 = j - t;
      const x0 = xin - X0;
      const y0 = yin - Y0;

      let i1 = 0, j1 = 0;
      if (x0 > y0) { i1 = 1; j1 = 0; } else { i1 = 0; j1 = 1; }

      const x1 = x0 - i1 + G2;
      const y1 = y0 - j1 + G2;
      const x2 = x0 - 1 + 2 * G2;
      const y2 = y0 - 1 + 2 * G2;

      const ii = i & 255;
      const jj = j & 255;
      const gi0 = perm[ii + perm[jj]] % 8;
      const gi1 = perm[ii + i1 + perm[jj + j1]] % 8;
      const gi2 = perm[ii + 1 + perm[jj + 1]] % 8;

      const t0 = 0.5 - x0 * x0 - y0 * y0;
      const t1 = 0.5 - x1 * x1 - y1 * y1;
      const t2 = 0.5 - x2 * x2 - y2 * y2;

      let n0 = 0, n1 = 0, n2 = 0;
      if (t0 > 0) {
        const t0s = t0 * t0;
        n0 = t0s * t0s * grad(gi0, x0, y0);
      }
      if (t1 > 0) {
        const t1s = t1 * t1;
        n1 = t1s * t1s * grad(gi1, x1, y1);
      }
      if (t2 > 0) {
        const t2s = t2 * t2;
        n2 = t2s * t2s * grad(gi2, x2, y2);
      }

      return 70 * (n0 + n1 + n2);
    }

    // --- Worley Noise ---
    function worley2(x, y) {
      let minDist = Infinity;
      for (const p of randomPoints) {
        const dx = x - p.x * 10;
        const dy = y - p.y * 10;
        const d = Math.sqrt(dx * dx + dy * dy);
        if (d < minDist) minDist = d;
      }
      return Math.min(minDist / 2, 1);
    }
  </script>
</body>
</html>